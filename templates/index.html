<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Name That Artist! ðŸŽµ - Music Quiz Game</title>
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Name That Artist! ðŸŽµ - Music Quiz Game">
    <meta property="og:description" content="Test your music knowledge! Listen to song previews and guess the artist in this fun music quiz game.">
    <meta property="og:image" content="https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=1200&h=630&fit=crop">
    <meta property="og:url" content="https://music-listener-9de283b930d7.herokuapp.com/">
    <meta property="og:type" content="website">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Name That Artist! ðŸŽµ - Music Quiz Game">
    <meta name="twitter:description" content="Test your music knowledge! Listen to song previews and guess the artist in this fun music quiz game.">
    <meta name="twitter:image" content="https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=1200&h=630&fit=crop">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
        }
        .quiz-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .score {
            font-size: 1.5rem;
            color: #2a5298;
        }
        .btn-play {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #2a5298;
            color: white;
            font-size: 1.5rem;
        }
        .btn-play:hover {
            background: #1e3c72;
            color: white;
        }
        #answer-input {
            border: 2px solid #2a5298;
            border-radius: 10px;
            padding: 0.75rem;
        }
        .feedback {
            font-size: 1.2rem;
            margin-top: 1rem;
            min-height: 2rem;
        }
        .correct {
            color: #28a745;
        }
        .incorrect {
            color: #dc3545;
        }
        #leaderboard {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #dee2e6;
        }
        .list-group-item {
            background: rgba(255, 255, 255, 0.8);
        }
        .modal-response {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            font-weight: bold;
        }
        .modal-answer {
            font-size: 1.2rem;
            color: #2a5298;
        }
        .modal-answer strong {
            color: #1e3c72;
            font-size: 1.3rem;
        }
        /* Select2 Styles */
        .select2-container {
            width: 100% !important;
        }
        .select2-container .select2-selection--multiple {
            min-height: 38px;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #2a5298;
            border: none;
            color: white;
            padding: 3px 8px;
            margin: 3px;
            border-radius: 3px;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: white;
            margin-right: 5px;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
            color: #ff9999;
        }
        .select2-dropdown {
            border: 1px solid #ced4da;
        }
        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: #2a5298;
        }
        #error-message {
            color: #842029;
            background-color: #f8d7da;
            border: 1px solid #f5c2c7;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            display: none;
            text-align: center;
            font-size: 1.1em;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #error-message.show {
            display: block !important;
        }
        
        #feedback {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            display: none;
            font-size: 1.1em;
            font-weight: 500;
        }
        
        #feedback.correct {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }
        
        #feedback.incorrect {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        
        #playAgainButton {
            display: none;
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 1.1em;
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        #playAgainButton:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        
        #feedback.game-over {
            background-color: #cce5ff;
            border-color: #b8daff;
            color: #004085;
            font-size: 1.2em;
            padding: 20px;
        }
        
        #post-answer-buttons {
            margin: 20px auto;
            display: none;
        }
        
        #post-answer-buttons .btn {
            padding: 8px 20px;
            font-weight: 500;
        }
        
        #tryAgainButton {
            display: none;
            margin: 20px auto;
            padding: 12px 30px;
            font-size: 1.2em;
            font-weight: 500;
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        #tryAgainButton:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        
        #nextQuestionButton {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        #nextQuestionButton:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        
        .input-group {
            max-width: 500px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="quiz-container text-center">
                    <h1 class="mb-4">Music Quiz</h1>
                    <p class="score mb-4">Score: <span id="score">0</span>/<span id="total">0</span></p>
                    
                    <!-- Username input at start -->
                    <div id="username-container" class="mb-4">
                        <input type="text" id="username-input" class="form-control mb-2" 
                               placeholder="Enter your username" autocomplete="off">
                        <button id="start-game" class="btn btn-primary">Start Game</button>
                    </div>
                    
                    <!-- Game container (initially hidden) -->
                    <div id="game-container" style="display: none;">
                        <h2 class="mb-4">Name That Artist! ðŸŽµ</h2>
                        
                        <!-- Add filter controls -->
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label for="genre-select" class="form-label">Select Genres</label>
                                <select id="genre-select" class="form-control" multiple>
                                    {% for genre in genres %}
                                    <option value="{{ genre }}">{{ genre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="decade-select" class="form-label">Select Decades</label>
                                <select id="decade-select" class="form-control" multiple>
                                    {% for decade in decades %}
                                    <option value="{{ decade }}">{{ decade }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div id="error-message" class="mb-4"></div>
                        <div id="feedback" class="mb-4"></div>
                        
                        <div class="d-flex justify-content-center align-items-center mb-4">
                            <button id="playButton" class="btn btn-play">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                        
                        <div class="input-group mb-3">
                            <input type="text" id="answer-input" class="form-control" placeholder="Enter artist or song name...">
                            <button id="submitButton" class="btn btn-primary">Submit Answer</button>
                        </div>
                        
                        <div class="btn-group mb-3" role="group" style="display: none;" id="post-answer-buttons">
                            <button id="nextQuestionButton" class="btn btn-primary">Next Question</button>
                        </div>
                        
                        <button id="tryAgainButton" class="btn btn-primary" style="display: none;">Try Again</button>
                        
                        <button id="playAgainButton" class="btn">Play Again</button>
                    </div>

                    <!-- Leaderboard -->
                    <div id="leaderboard" class="mt-4">
                        <h3>Top 10 Scores</h3>
                        <div id="leaderboard-list" class="list-group">
                            <!-- Leaderboard entries will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <h4 id="modalResult" class="mb-3"></h4>
                    <button id="nextSongButton" class="btn btn-primary">Next Song</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        let currentAudio = null;
        let score = 0;
        let total = 0;
        const MAX_SONGS = 6;
        const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        let username = '';
        let currentSong = null;
        
        // Fun response variations
        const correctResponses = [
            "ðŸŽ¯ You absolute genius!",
            "ðŸŽ¸ Rock on, music master!",
            "ðŸŒŸ You're on fire!",
            "ðŸŽ¼ Perfect pitch, maestro!",
            "ðŸŽµ You're crushing it!",
            "ðŸŽ§ Those ears don't lie!",
            "ðŸŽª Ladies and gentlemen, we have a winner!",
            "ðŸŽ­ You're a musical detective!",
            "ðŸŽª Standing ovation for you!",
            "ðŸŽ¨ Pure artistic brilliance!"
        ];
        
        const incorrectResponses = [
            "ðŸ¤” Nice try, Sherlock!",
            "ðŸ˜… Close, but no guitar!",
            "ðŸŽ­ Plot twist - different artist!",
            "ðŸŽª Back to music school!",
            "ðŸŽµ Almost had it!",
            "ðŸŽ§ Time to tune those ears!",
            "ðŸŒŸ Keep the rhythm going!",
            "ðŸŽ¼ Not quite the right note!",
            "ðŸŽ¸ Rock and... roll with it!",
            "ðŸŽ¯ Missing the mark, but keep shooting!"
        ];
        
        function getRandomResponse(responses) {
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        function updateScore() {
            document.getElementById('score').textContent = score;
            document.getElementById('total').textContent = total;
        }

        function updateLeaderboard() {
            fetch('/leaderboard')
                .then(response => response.json())
                .then(scores => {
                    const leaderboardList = document.getElementById('leaderboard-list');
                    leaderboardList.innerHTML = '';
                    scores.forEach((score, index) => {
                        const entry = document.createElement('div');
                        entry.className = 'list-group-item d-flex justify-content-between align-items-center';
                        entry.innerHTML = `
                            <span class="badge bg-primary rounded-pill me-2">${index + 1}</span>
                            <span class="flex-grow-1">${score.username}</span>
                            <span class="badge bg-secondary">${score.score}</span>
                        `;
                        leaderboardList.appendChild(entry);
                    });
                });
        }

        // Start game when username is submitted
        document.getElementById('start-game').addEventListener('click', () => {
            username = document.getElementById('username-input').value.trim();
            if (username) {
                fetch('/set_username', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username: username })
                })
                .then(() => {
                    document.getElementById('username-container').style.display = 'none';
                    document.getElementById('game-container').style.display = 'block';
                    loadNewSong();
                });
            }
        });

        function loadNewSong() {
            console.log('Loading new song...');
            
            // Stop and cleanup any existing audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.src = '';
                currentAudio = null;
            }
            
            // Reset UI state
            $('#playButton i').removeClass('fa-pause').addClass('fa-play');
            $('#playButton').hide();
            $('#submitButton').prop('disabled', true);
            $('#answer-input').prop('disabled', true).val('');
            $('#error-message').hide();
            $('#feedback').hide();
            $('#post-answer-buttons').hide();
            $('#tryAgainButton').hide();
            
            const selectedGenres = $('#genre-select').val() || [];
            const selectedDecades = $('#decade-select').val() || [];
            
            console.log('Current filters:', { genres: selectedGenres, decades: selectedDecades });
            
            fetch('/update_filters', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    genres: selectedGenres,
                    decades: selectedDecades
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error:', data.error);
                    $('#error-message')
                        .text(data.error)
                        .addClass('show')
                        .fadeIn();
                    return;
                }
                
                // Clear any previous error
                $('#error-message').removeClass('show').hide();
                
                // Update audio source and show play button
                currentAudio = new Audio(data.preview_url);
                currentSong = {
                    artist: data.artist,
                    song: data.song
                };
                
                // Add ended event listener
                currentAudio.addEventListener('ended', () => {
                    $('#playButton i').removeClass('fa-pause').addClass('fa-play');
                });
                
                $('#playButton').show();
                $('#submitButton').prop('disabled', false);
                $('#answer-input').prop('disabled', false);
            })
            .catch(error => {
                console.error('Error:', error);
                $('#error-message')
                    .text('Error loading song. Please try again.')
                    .addClass('show')
                    .fadeIn();
            });
        }
        
        // Play button click handler
        $('#playButton').on('click', function() {
            if (!currentAudio) return;
            
            const icon = $(this).find('i');
            if (currentAudio.paused) {
                currentAudio.play();
                icon.removeClass('fa-play').addClass('fa-pause');
            } else {
                currentAudio.pause();
                icon.removeClass('fa-pause').addClass('fa-play');
            }
        });

        // Auto-start game if username is already set (after reload)
        fetch('/check-session')
            .then(response => response.json())
            .then(data => {
                if (data.username) {
                    document.getElementById('username-container').style.display = 'none';
                    document.getElementById('game-container').style.display = 'block';
                    loadNewSong();
                }
            });

        // Next song button handler
        document.getElementById('nextSongButton').addEventListener('click', () => {
            // Don't load new song if game is over
            if (total >= MAX_SONGS) {
                showGameOver();
                return;
            }
            loadNewSong();
            resultModal.hide();
        });

        function showGameOver() {
            // Stop any playing audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.src = '';
                currentAudio = null;
            }
            
            // Hide game controls
            document.getElementById('playButton').style.display = 'none';
            document.getElementById('submitButton').style.display = 'none';
            document.getElementById('answer-input').style.display = 'none';
            document.getElementById('nextSongButton').style.display = 'none';
            
            const modalResult = document.getElementById('modalResult');
            modalResult.innerHTML = `
                <h3 class="mb-4">Game Over!</h3>
                <p class="modal-response">Final Score: ${score}/${MAX_SONGS}</p>
                <button onclick="window.location.href = window.location.href + '?t=' + new Date().getTime()" class="btn btn-primary mt-3">Play Again</button>
            `;
            
            // Update leaderboard
            updateLeaderboard();
        }
        
        // Submit answer
        $('#submitButton').on('click', function() {
            if (!currentSong) return;
            
            const answer = $('#answer-input').val().trim();
            if (!answer) return;
            
            // Disable input and submit button
            $('#answer-input').prop('disabled', true);
            $('#submitButton').prop('disabled', true);
            
            fetch('/check-answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    answer: answer,
                    artist: currentSong.artist,
                    song: currentSong.song
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Answer response:', data);
                
                // Update feedback
                const feedback = $('#feedback');
                feedback.text(data.message);
                feedback.removeClass('correct incorrect');
                feedback.addClass(data.correct ? 'correct' : 'incorrect');
                feedback.fadeIn();
                
                // Update score
                $('#score').text(data.score);
                $('#total').text(data.total);
                
                if (data.game_over) {
                    // Show game over message
                    $('#feedback')
                        .addClass('game-over')
                        .text(`Game Over! Your final score is ${data.score}/${data.total}. The last answer was: ${data.message}`)
                        .fadeIn();
                    
                    // Hide next question button
                    $('#post-answer-buttons').hide();
                    
                    // Show try again button
                    $('#tryAgainButton').fadeIn();
                    
                    // Update leaderboard
                    updateLeaderboard();
                } else {
                    // Show next question button
                    $('#post-answer-buttons').fadeIn();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                $('#feedback').text('Error checking answer. Please try again.').fadeIn();
                
                // Re-enable input and submit button
                $('#answer-input').prop('disabled', false);
                $('#submitButton').prop('disabled', false);
            });
        });
        
        // Next Question button handler
        $('#nextQuestionButton').on('click', function() {
            // Hide feedback and buttons
            $('#feedback').fadeOut();
            $('#post-answer-buttons').fadeOut();
            
            // Load new song
            loadNewSong();
        });
        
        // Try Again button handler (restarts the entire game)
        $('#tryAgainButton').on('click', function() {
            // Reset score and total
            $('#score').text('0');
            $('#total').text('0');
            
            // Clear and reset UI
            $('#feedback').fadeOut();
            $('#tryAgainButton').fadeOut();
            $('#answer-input').val('');
            
            // Clear genre and decade selections
            $('#genre-select').val([]).trigger('change');
            $('#decade-select').val([]).trigger('change');
            
            // Load new song
            loadNewSong();
        });
        
        // Handle Enter key in answer input
        $('#answer-input').on('keypress', function(e) {
            if (e.which === 13) {  // Enter key
                $('#submitButton').click();
            }
        });
        
        // Load leaderboard on page load
        updateLeaderboard();
        
        // Start with username input, don't load first song yet
        document.getElementById('game-container').style.display = 'none';
        
        // Initialize Select2
        $(document).ready(function() {
            $('#genre-select').select2({
                placeholder: 'Select genres...',
                allowClear: true
            });
            
            $('#decade-select').select2({
                placeholder: 'Select decades...',
                allowClear: true
            });
            
            // Add change handlers for filters
            $('#genre-select, #decade-select').on('change', function() {
                loadNewSong();
            });
        });
        
        // Play Again button handler
        $('#playAgainButton').on('click', function() {
            // Reset UI
            $('#score').text('0');
            $('#total').text('0');
            $('#feedback').hide();
            $('#playAgainButton').hide();
            
            // Enable controls
            $('#submitButton').prop('disabled', false);
            $('#answer-input').prop('disabled', false).val('');
            
            // Load new song
            loadNewSong();
        });
    </script>
</body>
</html>
