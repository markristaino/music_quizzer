<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Name That Artist! ðŸŽµ - Music Quiz Game</title>
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Name That Artist! ðŸŽµ - Music Quiz Game">
    <meta property="og:description" content="Test your music knowledge! Listen to song previews and guess the artist in this fun music quiz game.">
    <meta property="og:image" content="https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=1200&h=630&fit=crop">
    <meta property="og:url" content="https://music-listener-9de283b930d7.herokuapp.com/">
    <meta property="og:type" content="website">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Name That Artist! ðŸŽµ - Music Quiz Game">
    <meta name="twitter:description" content="Test your music knowledge! Listen to song previews and guess the artist in this fun music quiz game.">
    <meta name="twitter:image" content="https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?w=1200&h=630&fit=crop">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
        }
        .quiz-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .score {
            font-size: 1.5rem;
            color: #2a5298;
        }
        .btn-play {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #2a5298;
            color: white;
            font-size: 1.5rem;
        }
        .btn-play:hover {
            background: #1e3c72;
            color: white;
        }
        #answer-input {
            border: 2px solid #2a5298;
            border-radius: 10px;
            padding: 0.75rem;
        }
        .feedback {
            font-size: 1.2rem;
            margin-top: 1rem;
            min-height: 2rem;
        }
        .correct {
            color: #28a745;
        }
        .incorrect {
            color: #dc3545;
        }
        #leaderboard {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #dee2e6;
        }
        .list-group-item {
            background: rgba(255, 255, 255, 0.8);
        }
        .modal-response {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            font-weight: bold;
        }
        .modal-answer {
            font-size: 1.2rem;
            color: #2a5298;
        }
        .modal-answer strong {
            color: #1e3c72;
            font-size: 1.3rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="quiz-container text-center">
                    <h1 class="mb-4">Music Quiz</h1>
                    <p class="score mb-4">Score: <span id="score">0</span>/<span id="total">0</span></p>
                    
                    <!-- Username input at start -->
                    <div id="username-container" class="mb-4">
                        <input type="text" id="username-input" class="form-control mb-2" 
                               placeholder="Enter your username" autocomplete="off">
                        <button id="start-game" class="btn btn-primary">Start Game</button>
                    </div>
                    
                    <!-- Game container (initially hidden) -->
                    <div id="game-container" style="display: none;">
                        <div class="mb-4">
                            <button id="playButton" class="btn btn-play">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                        
                        <div class="mb-3">
                            <input type="text" id="answer-input" class="form-control" 
                                   placeholder="Who's the artist?" autocomplete="off">
                        </div>
                        
                        <button id="submitButton" class="btn btn-primary mb-3">Submit Answer</button>
                        
                        <div id="feedback" class="feedback"></div>
                    </div>

                    <!-- Leaderboard -->
                    <div id="leaderboard" class="mt-4">
                        <h3>Top 10 Scores</h3>
                        <div id="leaderboard-list" class="list-group">
                            <!-- Leaderboard entries will be added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <h4 id="modalResult" class="mb-3"></h4>
                    <button id="nextSongButton" class="btn btn-primary">Next Song</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentAudio = null;
        let score = 0;
        let total = 0;
        const MAX_SONGS = 6;
        const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        let username = '';
        
        // Fun response variations
        const correctResponses = [
            "ðŸŽ¯ You absolute genius!",
            "ðŸŽ¸ Rock on, music master!",
            "ðŸŒŸ You're on fire!",
            "ðŸŽ¼ Perfect pitch, maestro!",
            "ðŸŽµ You're crushing it!",
            "ðŸŽ§ Those ears don't lie!",
            "ðŸŽª Ladies and gentlemen, we have a winner!",
            "ðŸŽ­ You're a musical detective!",
            "ðŸŽª Standing ovation for you!",
            "ðŸŽ¨ Pure artistic brilliance!"
        ];
        
        const incorrectResponses = [
            "ðŸ¤” Nice try, Sherlock!",
            "ðŸ˜… Close, but no guitar!",
            "ðŸŽ­ Plot twist - different artist!",
            "ðŸŽª Back to music school!",
            "ðŸŽµ Almost had it!",
            "ðŸŽ§ Time to tune those ears!",
            "ðŸŒŸ Keep the rhythm going!",
            "ðŸŽ¼ Not quite the right note!",
            "ðŸŽ¸ Rock and... roll with it!",
            "ðŸŽ¯ Missing the mark, but keep shooting!"
        ];
        
        function getRandomResponse(responses) {
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        function updateScore() {
            document.getElementById('score').textContent = score;
            document.getElementById('total').textContent = total;
        }

        function updateLeaderboard() {
            fetch('/leaderboard')
                .then(response => response.json())
                .then(scores => {
                    const leaderboardList = document.getElementById('leaderboard-list');
                    leaderboardList.innerHTML = '';
                    scores.forEach((score, index) => {
                        const entry = document.createElement('div');
                        entry.className = 'list-group-item d-flex justify-content-between align-items-center';
                        entry.innerHTML = `
                            <span class="badge bg-primary rounded-pill me-2">${index + 1}</span>
                            <span class="flex-grow-1">${score.username}</span>
                            <span class="badge bg-secondary">${score.score}</span>
                        `;
                        leaderboardList.appendChild(entry);
                    });
                });
        }

        // Start game when username is submitted
        document.getElementById('start-game').addEventListener('click', () => {
            username = document.getElementById('username-input').value.trim();
            if (username) {
                fetch('/set_username', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username: username })
                })
                .then(() => {
                    document.getElementById('username-container').style.display = 'none';
                    document.getElementById('game-container').style.display = 'block';
                    loadNewSong();
                });
            }
        });
        
        // Next song button handler
        document.getElementById('nextSongButton').addEventListener('click', () => {
            // Don't load new song if game is over
            if (total >= MAX_SONGS) {
                showGameOver();
                return;
            }
            loadNewSong();
            resultModal.hide();
        });

        function loadNewSong() {
            if (total >= MAX_SONGS) {
                showGameOver();
                return;
            }
            
            fetch('/new-song')
                .then(response => response.json())
                .then(data => {
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio = null;
                    }
                    currentAudio = new Audio(data.preview_url);
                    currentAudio.addEventListener('ended', () => {
                        document.querySelector('#playButton i').className = 'fas fa-play';
                    });
                });
        }
        
        document.getElementById('playButton').addEventListener('click', () => {
            if (currentAudio) {
                if (currentAudio.paused) {
                    currentAudio.play();
                    document.querySelector('#playButton i').className = 'fas fa-pause';
                } else {
                    currentAudio.pause();
                    document.querySelector('#playButton i').className = 'fas fa-play';
                }
            }
        });
        
        document.getElementById('answer-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('submitButton').click();
            }
        });

        function showGameOver() {
            const modalResult = document.getElementById('modalResult');
            const lastAnswer = modalResult.innerHTML; // Save the last answer
            
            // Hide the next song button since game is over
            document.getElementById('nextSongButton').style.display = 'none';
            
            // Show the game over screen after a short delay to let user see the last answer
            setTimeout(() => {
                modalResult.innerHTML = `
                    <h3 class="mb-4">Game Over!</h3>
                    <p class="modal-response">Final Score: ${score}/${MAX_SONGS}</p>
                    ${lastAnswer}  <!-- Show the last answer -->
                `;
                
                // Add play again button
                const playAgainButton = document.createElement('button');
                playAgainButton.className = 'btn btn-primary mt-3';
                playAgainButton.textContent = 'Play Again';
                playAgainButton.onclick = resetGame;
                document.querySelector('.modal-body').appendChild(playAgainButton);
                
                // Disable the submit button and input
                document.getElementById('submitButton').disabled = true;
                document.getElementById('answer-input').disabled = true;
                document.getElementById('playButton').disabled = true;
                
                // Stop any playing audio
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                
                // Update leaderboard
                updateLeaderboard();
            }, 2000); // Wait 2 seconds before showing game over screen
        }
        
        function resetGame() {
            // Reset game state
            score = 0;
            total = 0;
            currentAudio = null;
            updateScore();
            
            // Re-enable all controls
            document.getElementById('submitButton').disabled = false;
            document.getElementById('answer-input').disabled = false;
            document.getElementById('playButton').disabled = false;
            document.getElementById('nextSongButton').style.display = 'block';
            
            // Clear input and feedback
            document.getElementById('answer-input').value = '';
            document.getElementById('feedback').innerHTML = '';
            
            // Load first song
            loadNewSong();
            
            // Hide the modal
            resultModal.hide();
        }
        
        // Update submit button handler
        document.getElementById('submitButton').addEventListener('click', () => {
            const submitButton = document.getElementById('submitButton');
            const answerInput = document.getElementById('answer-input');
            
            // Disable button and input while checking
            submitButton.disabled = true;
            answerInput.disabled = true;
            
            fetch('/check-answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    guess: answerInput.value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const modalResult = document.getElementById('modalResult');
                const response = data.correct ? 
                    `${getRandomResponse(correctResponses)}<br>` :
                    `${getRandomResponse(incorrectResponses)}<br>`;
                
                // Convert markdown bold to HTML bold
                const answer = data.answer.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                modalResult.innerHTML = `
                    <p class="modal-response">${response}</p>
                    <p class="modal-answer">The correct answer was: ${answer}</p>
                `;
                
                score = data.score;
                total = data.questions_answered;
                updateScore();
                
                // Clear and re-enable input
                answerInput.value = '';
                answerInput.disabled = false;
                submitButton.disabled = false;
                
                resultModal.show();
                
                if (total >= MAX_SONGS) {
                    showGameOver();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                submitButton.disabled = false;
                answerInput.disabled = false;
            });
        });
        
        // Load leaderboard on page load
        updateLeaderboard();
        
        // Start with username input, don't load first song yet
        document.getElementById('game-container').style.display = 'none';
    </script>
</body>
</html>
